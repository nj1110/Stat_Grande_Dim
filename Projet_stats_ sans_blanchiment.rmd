---
title: "Projet_stat_IODAA"
authors: "Anne-Cécile TOULEMONDE,Nora PICAUT,Noémie JACQUET"
date: "2023-01-20"
output:
  beamer_presentation: default
  powerpoint_presentation: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Préparartion de l'espace de travail 

#### Espace de  travail 
```{r}
setwd("/cloud/project")
```

#### Installation des packages 

```{r}
install.packages("contrib.url")
install.packages("FactoMinerR")
install.packages("corrplot")
install.packages("factoextra")
install.packages("VIM")
```


```{r}
install.packages("/cloud/project/MultiVarSel_1.0.tar", repos = NULL, type = 'source')
```

```{r cars}
library(readr)
library(tidyverse)
library(corrplot)
library(FactoMineR)
library(factoextra)
library(ggplot2)
library(missMDA)
```


```{r cars}
library(glmnet)
library(MultiVarSel)
```

#### Importation des données 

```{r pressure, echo=FALSE}
df = read.csv2("Table_proteome_CD_all.csv")
```

## Objectifs du projet
Etude de l'influence de la température et du stade d'imbibition sur la capacité germinative des graines à l'aide de données de protéomique pour des graines ayant subi un vieillissement artificiel immédiat (CD_0d).

lignes = les graines, n = 54

colonnes = descripteurs --> nom des samples, rep (les samples sont répartis dans chaque rep), temp, stade inibition, capacité germ, prots 266

**Descripteurs:** 
- température (variable qualitative à 3 modalités : *Low*, *Medium* et *Elevated*
- stade d'imbibition (variable qualitative à 3 modalités :*DS* , *EI* , *LI*

**Variable à prédire** : (variable qualitative) Capacité germinative des graines à l'aide de données de protéomique pour des graines ayant subi un vieillissement artificiel immédiat (CD_0d).


## Analyse descriptive 
### Nombre de lignes et colonnes 
```{r}
dim(df)
```

### Apercu du jeu de données 
```{r}
head(df)
table(df$rep)
```
#### Liste des variables 
```{r}
names(df) # Liste des variables 
```
#### Type des variables 

```{r}
str(df) ## Type de colonnes 
```

#### Dispersion des variables 
Informations descriptives 
```{r}
summary(df)
```

```{r}
df_cd0 = df[df$treatment == 'CD_0d', -6]
df_cd0_1 = df_cd0[,6:length(df_cd0)]

```
### heatmap
```{r}
d = dist(as.matrix(df_cd0_1))

plt <- heatmap(as.matrix(d))
```


### Analyse à composantes principales
### ACP 

```{r}
res.pca = PCA(df_cd0_1,graph = FALSE)
get_eigenvalue(res.pca)
fviz_pca_var(res.pca,axes=1:2)
fviz_pca_ind(res.pca,axes=1:2)
```


*Nombre de valeurs manquantes *
```{r}
library(VIM)

res = summary(aggr(df,sortVar = TRUE))$group
matrixplot(df,sortby = 2 )
```
Il n'y a pas de valeurs manquantes dans ce jeu de données. 

```{r}
Y <- as.matrix(df_cd0_1)
X_temp <- df_cd0[,4]
X_in <- df_cd0[,5]
```


```{r}
table(X_temp,X_in)
dim(Y)
```

*créer la matrice design*
```{r}
X <- model.matrix(lm(Y ~ X_temp+0))
dim(X)
print(X)

```

# normalise les données d'abondance des protéines
```{r}
Yscaled = scale(Y)
Y = Yscaled
dim(Y)
n = dim(Y)[1]
p = dim(X)[2]
q = dim(Y)[2]
```


##############################################################################################
## Sans blanchiment
# sans selection de variables
#temperature
```{r}
Y <- as.matrix(df_cd0_1)
X_temp <- df_cd0[,4]
X_in <- df_cd0[,5]
```


```{r}
table(X_temp,X_in)
dim(Y)
```

# normalise les données d'abondance des protéines
```{r}
Yscaled = scale(Y)
Y = Yscaled
dim(Y)
```


```{r}
X <- model.matrix(lm(Y ~ X_in+0))
```


```{r}
n = dim(Y)[1]
p = dim(X)[2]
q = dim(Y)[2]
```
# vectoriser
```{r}
dim(Y)
Yvec=as.numeric(Y)
Xvec=kronecker(diag(q),X)
length(Yvec)
```

```{r}
dim(Xvec)
```

```{r}
resultat_cv=cv.glmnet(Xvec,Yvec,nfolds=10,family="gaussian",alpha=1,grouped=T)
lambda_min=resultat_cv$lambda.min
```

```{r}
nb_repli=50
stabsel.glmnet <- function(i) {
b_sort <- sort(sample(1:(n*q),floor((n*q)/2)))
resultat_glmnet=glmnet(Xvec[b_sort,],Yvec[b_sort],family="gaussian",alpha=1,lambda=lambda_min)
ind_glmnet=which(resultat_glmnet$beta!=0)
return(tabulate(ind_glmnet,(p*q)))}
res.cum <- Reduce("+", lapply(1:nb_repli, stabsel.glmnet))
```


```{r}
result <- replicate(nb_repli, stabsel.glmnet(i))
dim(result)

```

```{r}
ind=which((res.cum/nb_repli)==1)
length(ind)
length(res.cum)
```


```{r}
prot<- rep(names(df_cd0_1), each = 3)
modalites_temp <- rep(c(df_cd0$temperature), times = 260)
modalites_im <- rep(c(df_cd0$imbibition), times = 260)

```

```{r}
b = cbind(as.data.frame(res.cum), prot, modalites_temp)

b <- b[ind, ]
table(b$modalites)
```

```{r}
pdf("p_im.pdf") 

ggplot(data=b, aes(x=prot,y=modalites_im,color=modalites_im))+
geom_point(size=1)+theme_bw()+ylab('Levels of X')+xlab('m/z')+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5))

dev.off() 


```
# tempétarture
sur les 45 prot qui sont le plus influencées par la temperature, on peut dire que les prot sont plus abondantes (s'expriment plus) pour les tempratures elevées ou bien faibles. Les prot s'expriment peu pour les températures medium.

# imbibition
il reste 253 prot ce qui est bcp et rend l'interprétation difficile. On peut dire qu'il n'y a pas de 