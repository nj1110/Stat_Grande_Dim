---
title: "Multivarsel_fonction"
author: "Anne-Cécile TOULEMONDE"
date: "2023-02-07"
output: pdf_document
---

## Préparartion de l'espace de travail 

#### Installation des packages 

```{r}
install.packages("contrib.url")
install.packages("FactoMinerR")
install.packages("corrplot")
install.packages("factoextra")
install.packages("VIM")
install.packages("MultiVarSel")
install.packages("DescTools")
```

```{r cars}
library(readr)
library(tidyverse)
library(corrplot)
library(FactoMineR)
library(factoextra)
library(ggplot2)
library("VIM")
library(glmnet)
library(MultiVarSel)
library(DescTools)
```

#### Importation des données 
```{r}
setwd("C:/Users/actou/OneDrive/Documents/IODAA/Statistiques")
```

```{r pressure, echo=FALSE}
df = read.csv2("Table_proteome_CD_all.csv")
```

## Objectifs du projet
Etude de l'influence de la température et du stade d'imbibition sur la capacité germinative des graines à l'aide de données de protéomique pour des graines ayant subi un vieillissement artificiel immédiat (CD_0d).

**Descripteurs:** 
- température (variable qualitative à 3 modalités : *Low*, *Medium* et *Elevated*
- stade d'imbibition (variable qualitative à 3 modalités :*DS* , *EI* , *LI*

**Variable à prédire** : (variable qualitative) Capacité germinative des graines à l'aide de données de protéomique
pour des graines ayant subi un vieillissement artificiel immédiat (CD_0d).

## QUESTION 1 Analyse descriptive 
### Nombre de lignes et colonnes 
```{r}
dim(df)
```
```{r}
head(df)
```
```{r}
names(df[1:10]) # Liste des variables 
```
#### Type des variables 

```{r}
str(df[1:10]) ## Type de colonnes 
```

#### Dispersion des variables 
Informations descriptives 
```{r}
#summary(df) 
```

### Anlayse des corrélations (variables quantitatives)
Matrice de corrélation à partor de la 7eme colonne du dataset 
```{r}
library(corrplot)
df1=df[df$treatment=="CD_0d", c(7:length(df))]
head(df1)
corrplot(cor(df1))
```

``

### Analyse à composantes principales 
L'ACP n'est pas suffisante: il faut attendre le 5e axe pour expliquer 70% de la variance cumulée.PAS TRES INTERPRETABLE L'ACP sur les protéines donc on doit faire de la sélection de variable
```{r}
res.pca = PCA(df1,graph = FALSE)
get_eigenvalue(res.pca)
fviz_pca_var(res.pca,axes=1:2)
fviz_pca_ind(res.pca,axes=1:2)
fviz_pca_var(res.pca, axes = c(1:3))
```


#### Prétraitement 
Nombre de valeurs manquantes 
```{r}
res = summary(aggr(df,sortVar = TRUE))$group
matrixplot(df,sortby = 2 )
```
Il n'y a pas de valeurs manquantes dans ce jeu de données. 

###  Analyse descriptive : HEATMAP de correlation entre les métabolites 
Heatmap des protéines pour voir si corrélées entre elles, justement on verra rien meme en acp etc d'ou la necessité de faire de la selection de variables. Plus c'est rouge plus il y a de corrélation: groupe de protéines en bas à droite corrélées entre elles, mais il y en a bcp on doit aller plus loin et faire de la sélection de variables
```{r}
head(df1)
heatmap(abs(cor(df1)), symm=TRUE)
```


### QUESTION 2 - Analyse 

```{r}
Analyse_prot_stat = function(df,white_model,frequency)
  {
  ## Variables 
  white_model = as.character(white_model)
  
  ## matrice de design 
  rownames(df) <- NULL
  X_temp <- factor(as.character(df[,1]))
  Y_temp <- as.matrix(df_temp[,2:length(df)])
  Y_temp <- scale(Y_temp)
  mat_temp <- model.matrix(lm(Y_temp~ X_temp+ 0))
  
  ## Analyse des réisus et test du portemeanteau
  residuals=lm(as.matrix(Y_temp)~mat_temp-1)$residuals
  pval_temp = whitening_test(residuals)
  
  sprintf("Test du Portemeanteau: pvalue = %s",round(pval_temp,2))
  sprintf("Le nombre de lignes est %i et le nombre de colonnes %i",nrow(mat_temp),ncol(mat_temp))
  sprintf("les dimensions de la matrice du modèle sont %i",dim(mat_temp)[2])
  
  result_blanchiement=whitening_choice(residuals,c("AR1","nonparam","ARMA"),pAR=1,qMA=1)
  print(result_blanchiement) # selection du meilleur modèle pour repésenter la   dépendance des résidus 
  
  # Calcul estimateur de sigma 
  square_root_inv_hat_Sigma=whitening(residuals,white_model,pAR=1,qMA=0)
  
  # Selection des variables
  Frequencies=variable_selection(Y_temp,mat_temp,square_root_inv_hat_Sigma,nb_repli=100,parallel=FALSE)
  
  # Graphiques:
  colnames(Frequencies)<-c('Names_of_Y','Names_of_X','frequency')
  Frequencies$Names_of_X<-sub('X_df2', '',Frequencies$Names_of_X)
  Frequencies$Names_of_Y<-as.numeric(StrRight(gsub('p_AT','',gsub('\\.1$','',Frequencies$Names_of_Y)), 5))
  
  
  plot_blanch<-ggplot(data=Frequencies[Frequencies$frequency>=0.95,], aes(x=Names_of_Y,y=Names_of_X,color=frequency))+
    geom_tile(size=0.75)+
    scale_color_gradient2(midpoint=0.95,mid ='orange')+
    theme_bw()+ylab('Levels of X')+xlab('m/z')

  boulier_blanch<-ggplot(data=Frequencies[Frequencies$frequency==frequency,], aes(x=Names_of_Y,y=Names_of_X,color=Names_of_X))+
  geom_point(size=1)+theme_bw()+ylab('Levels of X')+xlab('m/z')
  
  
  return(list(sprintf("Test du Portemeanteau: pvalue = %s",round(pval_temp,2)),sprintf("Le nombre de lignes est %i et le nombre de    colonnes %i",nrow(mat_temp),ncol(mat_temp)),sprintf("les dimensions de la matrice du modèle sont %i",dim(mat_temp)[2]),boulier_blanch,plot_blanch))
}
```

### ANOVA 1 Facteur avec blanchiement: Temperature 
```{r}
df_temp= df[df$treatment=="CD_0d", c(4,7:length(df))]
Analyse_prot_stat(df_temp,"nonparam",1)
```

### ANOVA 1 Facteur avec blanchiement :Imbibition 
```{r}
df_imbib= df[df$treatment=="CD_0d", c(5,7:length(df))]
Analyse_prot_stat(df_imbib,"AR1",1)
```

### ANOVA 2 facteurs (températures et imbibition AVEC blanchiement et SANS interaction)
```{r}

# Fusionner les deux colonnes tmperature et imbibition
df_2fac_sans_inter= df[df$treatment=="CD_0d", c(4,5,7:length(df))]
rownames(df_2fac_sans_inter) <- NULL

df_2fac_sans_inter$temp_imb <-paste0(df_2fac_sans_inter$temperature, "_", df_2fac_sans_inter$imbibition)
df_2fac_sans_inter$temperature <- NULL  
df_2fac_sans_inter$imbibition <- NULL

# Mettre la colonne tmp_imb en première colonne 
library(dplyr)
df_2fac_sans_inter %>% select(temp_imb, everything()) -> df_2fac_sans_inter

# Appliquer la meme fonction 
Analyse_prot_stat(df_2fac_sans_inter,"nonparam",0.9)
```

### ANOVA 2 facteurs (températures et imbibition) AVEC blanchiement et AVEC interactions)


```{r}
df_2fac_inter= df[df$treatment=="CD_0d", c(4,5,7:length(df))]
rownames(df_2fac_inter) <- NULL

X1_dfint<- factor(as.character(df_2fac_inter[, 1]))
X2_dfint<- factor(as.character(df_2fac_inter[, 2]))
Y_int <- as.matrix(df_2fac_inter[,3:length(df_2fac_inter)])
Y_int <- scale(Y_int)
Xint <- model.matrix(lm(Y_int~ (X1_dfint:X2_dfint) + 0))

## Whitening test
residuals=lm(as.matrix(Y_int)~Xint-1)$residuals
pvalue = whitening_test(residuals)
sprintf("pvalue %s",round(pvalue,2))
result = whitening_choice(residuals,c("AR1","nonparam","ARMA"),pAR=1,qMA=1)
result

square_root_inv_hat_Sigma=whitening(residuals,"nonparam",pAR=1,qMA=0)
Frequencies=variable_selection(Y_int,Xint,square_root_inv_hat_Sigma,nb_repli=100,parallel=FALSE)
colnames(Frequencies)<-c('Names_of_Y','Names_of_X','frequency')
Frequencies$Names_of_X<-sub('X1_dfint', '', sub('X2_dfint', '',Frequencies$Names_of_X))
Frequencies$Names_of_Y<-as.numeric(StrRight(gsub('p_AT','',gsub('\\.1$','',Frequencies$Names_of_Y)), 5))

## Graph
plot<-ggplot(data=Frequencies[Frequencies$frequency>=0.95,], aes(x=Names_of_Y,y=Names_of_X,color=frequency))+
geom_tile(size=0.75)+scale_color_gradient2(midpoint=0.95,mid ='orange')+
theme_bw()+ylab('Levels of X')+xlab('ratio m/z of the metabolites.')
data=Frequencies[Frequencies$frequency>=0.95,]
plot

boulier<-ggplot(data=Frequencies[Frequencies$frequency==1,], aes(x=Names_of_Y,y=Names_of_X,color=Names_of_X))+
geom_point(size=1)+theme_bw()+ylab('Levels of X')+xlab('m/z')
boulier


```

# SANS BLANCHIEMENT 
### Fonction 

```{r}
stabsel.glmnet <- function(i)
  {
    b_sort <- sort(sample(1:(n*q),floor((n*q)/2)))
    resultat_glmnet=glmnet(Xvec[b_sort,],Yvec[b_sort],family="gaussian",alpha=1,lambda=lambda_min)
    ind_glmnet=which(resultat_glmnet$beta!=0)
    
    return(tabulate(ind_glmnet,(p*q)))
}
```


```{r}
df_sb_temp= df[df$treatment=="CD_0d", c(4,7:length(df))]
df_sb_im= df[df$treatment=="CD_0d", c(5,7:length(df))]
rownames(df_sb_temp) <- NULL
rownames(df_sb_im) <- NULL

# matrice de design 
X_sb_temp = factor(as.character(df_sb_temp[,1]))
X_sb_im = factor(as.character(df_sb_im[,1]))
table(X_sb_temp,X_sb_im)

# normalise les données d'abondance des protéines
Y_sb = as.matrix(df_temp[,2:length(df_sb_temp)])
Y_sb = scale(Y_sb)
dim(Y_sb)
#mat_temp <- model.matrix(lm(Y_temp~ X_temp+ 0))

## Modèles
model_sb_im =  model.matrix(lm(Y_sb ~ X_sb_im+0))
model_sb_temp =  model.matrix(lm(Y_sb ~ X_sb_temp+0))

# dimensions 
n = dim(Y_sb)[1]
p = dim(X_sb_im)[2]
q = dim(Y_sb)[2]

# vectoriser imbibition
Yvec=as.numeric(Y_sb)
Xvec_sb_imb=kronecker(diag(q),model_sb_im)
dim(Xvec_sb_imb)

# resultats
resultat_cv=cv.glmnet(Xvec_sb_imb,Yvec,nfolds=10,family="gaussian",alpha=1,grouped=T)
lambda_min=resultat_cv$lambda.min

res.cum <- Reduce("+", lapply(1:nb_repli, stabsel.glmnet))

nb_repli=100
result <- replicate(nb_repli, stabsel.glmnet(i))
#dim(result)
ind=which((res.cum/nb_repli)==1)
#print(length(ind),length(res.cum))

prot<- rep(names(df_cd0_1), each = 3)
modalites_temp <- rep(c(df_sb_temp$temperature), times = 260)
modalites_im <- rep(c(df_sb_im$imbibition), times = 260)

b = cbind(as.data.frame(res.cum), prot, modalites_temp)
b <- b[ind, ]
table(b$modalites)
```

```{r}
pdf("plot_im.pdf") 
ggplot(data=b, aes(x=prot,y=modalites_im,color=modalites_im))+
geom_point(size=1)+theme_bw()+ylab('Levels of X')+xlab('m/z')+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
dev.off() 
```
# tempétarture
sur les 45 prot qui sont le plus influencées par la temperature, on peut dire que les prot sont plus abondantes (s'expriment plus) pour les tempratures elevées ou bien faibles. Les prot s'expriment peu pour les températures medium.

# imbibition
il reste 253 prot ce qui est bcp et rend l'interprétation difficile. On peut dire qu'il n'y a pas de 

#------------------------------------------------
#-------------------------------------------------

```{r}
df_temp= df[df$treatment=="CD_0d", c(4,7:length(df))]
X_temp <- df[,1]

Y_sb = as.matrix(df_temp[,2:length(df_temp)])
Y_sb = scale(Y_sb)
dim(Y_sb)

#créer la matrice design*
model <- model.matrix(lm(Y_sb ~ X_temp+0))
dim(model)
print(model)
```

# normalise les données d'abondance des protéines

```{r}
df_sb_temp= df[df$treatment=="CD_0d", c(4,7:length(df))]
rownames(df_sb_temp) <- NULL
X_sb_temp = factor(as.character(df_sb_temp[,1]))

```

```{r}
Yscaled = scale(Y)
Y = Yscaled
dim(Y)
n = dim(Y)[1]
p = dim(X)[2]
q = dim(Y)[2]
```


##############################################################################################
## Sans blanchiment
# sans selection de variables
#temperature
```{r}
Y <- as.matrix(df_cd0_1)
X_temp <- df_cd0[,4]
X_in <- df_cd0[,5]
```


```{r}
table(X_temp,X_in)
dim(Y)
```

# normalise les données d'abondance des protéines
```{r}
Yscaled = scale(Y)
Y = Yscaled
dim(Y)
```


```{r}
X <- model.matrix(lm(Y ~ X_in+0))
```


```{r}
n = dim(Y)[1]
p = dim(X)[2]
q = dim(Y)[2]
```
# vectoriser
```{r}
dim(Y)
Yvec=as.numeric(Y)
Xvec=kronecker(diag(q),X)
length(Yvec)
```

```{r}
dim(Xvec)
```

```{r}
resultat_cv=cv.glmnet(Xvec,Yvec,nfolds=10,family="gaussian",alpha=1,grouped=T)
lambda_min=resultat_cv$lambda.min
```

```{r}
nb_repli=50
stabsel.glmnet <- function(i) {
b_sort <- sort(sample(1:(n*q),floor((n*q)/2)))
resultat_glmnet=glmnet(Xvec[b_sort,],Yvec[b_sort],family="gaussian",alpha=1,lambda=lambda_min)
ind_glmnet=which(resultat_glmnet$beta!=0)
return(tabulate(ind_glmnet,(p*q)))}
res.cum <- Reduce("+", lapply(1:nb_repli, stabsel.glmnet))
```


```{r}
result <- replicate(nb_repli, stabsel.glmnet(i))
dim(result)
```

```{r}
ind=which((res.cum/nb_repli)==1)
length(ind)
length(res.cum)
```


```{r}
prot<- rep(names(df_cd0_1), each = 3)
modalites_temp <- rep(c(df_cd0$temperature), times = 260)
modalites_im <- rep(c(df_cd0$imbibition), times = 260)
```

```{r}
b = cbind(as.data.frame(res.cum), prot, modalites_temp)
b <- b[ind, ]
table(b$modalites)
```

```{r}
pdf("p_im.pdf") 
ggplot(data=b, aes(x=prot,y=modalites_im,color=modalites_im))+
geom_point(size=1)+theme_bw()+ylab('Levels of X')+xlab('m/z')+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
dev.off() 
```
# tempétarture
sur les 45 prot qui sont le plus influencées par la temperature, on peut dire que les prot sont plus abondantes (s'expriment plus) pour les tempratures elevées ou bien faibles. Les prot s'expriment peu pour les températures medium.

# imbibition
il reste 253 prot ce qui est bcp et rend l'interprétation difficile. On peut dire qu'il n'y a pas de 










